@page
@model ManageUsersModel
@{
    ViewData["Title"] = "Benutzerverwaltung";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>👥 Benutzerverwaltung</h2>
        <a asp-page="/Admin/CreateUser" class="btn btn-success">
            ➕ Neuen Benutzer anlegen
        </a>
    </div>

    @* Erfolgs-Meldung mit Passwort *@
    @if (TempData["TempPassword"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">✅ Benutzer erfolgreich erstellt!</h5>
            <hr>
            <p><strong>E-Mail:</strong> @TempData["UserEmail"]</p>
            <p><strong>Einmal-Passwort:</strong> <code class="fs-5">@TempData["TempPassword"]</code></p>
            <p class="mb-0"><small>⚠️ Notieren Sie dieses Passwort - es wird nicht erneut angezeigt!</small></p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Normale Erfolgsmeldungen *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            @if (TempData["TempPassword"] != null && TempData["UserEmail"] != null)
            {
                <hr>
                <p><strong>Neues Passwort für @TempData["UserEmail"]:</strong></p>
                <p><code class="fs-5">@TempData["TempPassword"]</code></p>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Fehler-Meldungen *@
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Benutzer-Tabelle *@
    <div class="card">
        <div class="card-body">
            @if (Model.Users.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>E-Mail</th>
                                <th>Rollen</th>
                                <th style="width: 300px;">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.Users)
                            {
                                <tr>
                                    <td class="align-middle">
                                        <strong>@user.Email</strong>
                                    </td>
                                    <td class="align-middle">
                                        @if (user.Roles.Any())
                                        {
                                            @foreach (var role in user.Roles)
                                            {
                                                <span class="badge bg-primary me-1">@role</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Keine Rollen</span>
                                        }
                                    </td>
                                    <td class="align-middle">
                                        <div class="btn-group" role="group">
                                            <!-- Rollen verwalten -->
                                            <button type="button" class="btn btn-sm btn-warning"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#roleModal-@user.Id">
                                                🔧 Rollen
                                            </button>

                                            <!-- Passwort zurücksetzen -->
                                            <form method="post" asp-page-handler="ResetPassword" class="d-inline">
                                                <input type="hidden" name="userId" value="@user.Id" />
                                                <button type="submit" class="btn btn-sm btn-info"
                                                        onclick="return confirm('Passwort für @user.Email wirklich zurücksetzen?')">
                                                    🔑 Reset
                                                </button>
                                            </form>

                                            <!-- Benutzer löschen -->
                                            <form method="post" asp-page-handler="DeleteUser" class="d-inline">
                                                <input type="hidden" name="userId" value="@user.Id" />
                                                <button type="submit" class="btn btn-sm btn-danger"
                                                        onclick="return confirm('Benutzer @user.Email wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden!')">
                                                    🗑️ Löschen
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Modal für Rollen-Management -->
                                <div class="modal fade" id="roleModal-@user.Id" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Rollen für @user.Email</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <h6 class="mb-3">✅ Aktuelle Rollen:</h6>
                                                @if (user.Roles.Any())
                                                {
                                                    <div class="mb-3">
                                                        @foreach (var role in user.Roles)
                                                        {
                                                            <form method="post" asp-page-handler="RemoveRole" class="d-inline">
                                                                <input type="hidden" name="userId" value="@user.Id" />
                                                                <input type="hidden" name="role" value="@role" />
                                                                <button type="submit" class="btn btn-sm btn-outline-danger mb-2">
                                                                    ❌ @role entfernen
                                                                </button>
                                                            </form>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <p class="text-muted">Keine Rollen zugewiesen</p>
                                                }

                                                <hr />

                                                <h6 class="mb-3">➕ Rolle hinzufügen:</h6>
                                                <div>
                                                    @foreach (var role in Model.AllRoles)
                                                    {
                                                        if (!user.Roles.Contains(role))
                                                        {
                                                            <form method="post" asp-page-handler="AddRole" class="d-inline">
                                                                <input type="hidden" name="userId" value="@user.Id" />
                                                                <input type="hidden" name="role" value="@role" />
                                                                <button type="submit" class="btn btn-sm btn-outline-success mb-2">
                                                                    ➕ @role hinzufügen
                                                                </button>
                                                            </form>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Schließen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-0">
                    <strong>ℹ️ Keine Benutzer vorhanden.</strong>
                    <br>
                    <a asp-page="/Admin/CreateUser" class="alert-link">Ersten Benutzer erstellen</a>
                </div>
            }
        </div>
    </div>
</div>