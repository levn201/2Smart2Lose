@page
@model Smart2Lose.Pages.Admin.FrageboegenErstellenModel
@{
    ViewData["Title"] = "Kahoot | Fragebögen Erstellen";
}

<link rel="stylesheet" href="~/css/Admin/GrundDashboard.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Admin/FrageboegenErstellen.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Admin/FrageboegenPopUp.css" asp-append-version="true" />



<!-- Header -->
<header class="header">
    <div class="logo">@Model.pn.Name</div>

    <nav class="nav-links">

        <a href="/Admin/Dashboard">Dashboard</a>

        @if (User.IsInRole("Admin"))
        {
            <a href="/Admin/User">User</a>
        }

        <a href="/Admin/Frageboegen" class="active">Fragebögen</a>

        <a href="/Admin/FrageboegenErstellen">Neue anlegen</a>

        <a href="/Index">Quit</a>

    </nav>
</header>

<<<<<<< Updated upstream
<div class="main-content" id="neu">
    <h2>Neuen Fragebogen anlegen</h2>
    <p>Erstelle einen neuen Fragebogen mit individuellen Fragen und Einstellungen.</p>
</div>


<!-- Hier wird der Titel eingeladen mit der URzeit Joincode und  -->
<div class="main-content">
    <h2>Neues Quiz erstellen</h2>


    <form method="post" asp-page-handler="Kategorie">
        <div class="filter-item">
            <label asp-for="Kategorie">Kategorie</label>
            <select asp-for="Kategorie" id="category" class="form-select" onchange="this.form.submit()">

                <option value="Unternehmen">Unternehmenswissen</option>
                <option value="Sicherheit">Gesundheit & Sicherheit</option>
                <option value="Technik">Technik & Tools</option>
                <option value="Skills">Soft Skills</option>

            </select>
        </div>
    </form>
    

    <form method="post">
        <label for="quizTitle">Quiz-Titel:</label>
        <input type="text" id="quizTitle" name="Titel" placeholder="Titel des Quizzes eingeben" value="@Model.Titel" />

        @if (!string.IsNullOrEmpty(Model.TitelError))
        {
            <p class="message">@Model.TitelError</p>
=======
<div class="main-content">

    <h2>Neues Quiz erstellen</h2>

    <form method="post" asp-page-handler="AddFrage" id="fragenForm">

        <!-- META -->
        <div class="quiz-meta">

            <!-- Kategorie -->
            <div class="filter-item">

                <label>Kategorie</label>

                <select asp-for="fb.Kategorie" class="form-select">

                    <option value="Unternehmen">Unternehmenswissen</option>
                    <option value="Sicherheit">Gesundheit & Sicherheit</option>
                    <option value="Technik">Technik & Tools</option>
                    <option value="Skills">Soft Skills</option>

                </select>

            </div>

            <!-- Titel -->
            <div class="titel-box">

                <label>Quiz-Titel</label>

                <input asp-for="fb.Titel"
                       placeholder="Titel des Quizzes eingeben" />

                @if (!string.IsNullOrEmpty(Model.FragenError))
                {
                    <p class="message">@Model.FragenError</p>
                }

                <div class="joincode-box">

                    <span>Join-Code</span>
                    <strong>@Model.fb.JoinId</strong>

                </div>

            </div>

        </div>


        <input type="hidden" asp-for="fb.JoinId" />


        <!-- FRAGEN -->
        <div id="fragenContainer">

            <div class="frage-container quiz-frage" data-index="0">

                <button type="button"
                        class="frage-loeschen"
                        onclick="removeFrage(this)">
                    ✖
                </button>

                <h3>Fragestellung</h3>

                <textarea class="frage-text"
                          name="fb.Fragen[0].Fragestellung"
                          rows="3"
                          placeholder="Geben Sie hier die Frage ein"></textarea>

                <h3>Antwortoptionen</h3>

                <div class="antwort-grid">

                    @for (int i = 1; i <= 4; i++)
                    {
                        <div class="antwort-option">

                            <textarea name="fb.Fragen[0].Antwort@(i)"
                                  placeholder="Antwort @i"></textarea>

                            <label>

                                <input type="checkbox"
                                       name="fb.Fragen[0].IstAntwort@(i)Richtig"
                                       value="true" />

                                Richtig

                            </label>

                        </div>
                    }

                </div>

            </div>

        </div>


        <!-- FEHLER -->
        @if (!string.IsNullOrEmpty(Model.FragenError))
        {
            <div class="frage-container error">
                @Model.FragenError
            </div>
        }


        <!-- BUTTONS -->
        <div class="button-row">

            <button type="button"
                    class="knopf"
                    onclick="addFrage()">

                Frage hinzufügen

            </button>

            <button type="submit"
                    class="knopf">

                Fragebogen speichern

            </button>

        </div>

    </form>

</div>



<script>

    let frageIndex = 1;

    function addFrage() {

        const container = document.getElementById("fragenContainer");
        const letzte = container.querySelector(".quiz-frage:last-child");

        const neu = letzte.cloneNode(true);

        neu.setAttribute("data-index", frageIndex);

        // Frage
        const frage = neu.querySelector('textarea[name*="Fragestellung"]');
        frage.name = `fb.Fragen[${frageIndex}].Fragestellung`;
        frage.value = "";

        // Antworten
        for (let i = 1; i <= 4; i++) {

            const text = neu.querySelector(`textarea[name*="Antwort${i}"]`);
            text.name = `fb.Fragen[${frageIndex}].Antwort${i}`;
            text.value = "";

            const check = neu.querySelector(`input[name*="IstAntwort${i}Richtig"]`);
            check.name = `fb.Fragen[${frageIndex}].IstAntwort${i}Richtig`;
            check.checked = false;
            check.value = "true";
>>>>>>> Stashed changes
        }
        <button type="submit">Quiz erstellen</button>
    </form>
</div>

<<<<<<< Updated upstream
<!-- Das Popup -->
<div id="quizPopup" class="popup-overlay" style="display: none;">
    <form method="post" asp-page-handler="AddFrage" class="popup-content">
        <!-- Popup Header -->
        <div class="popup-header">
            <h2>Frage erstellen</h2>
            <button type="button" onclick="closeQuizPopup()" class="close-btn">&times;</button>
        </div>

        <!-- Popup Body -->
        <div class="popup-body">
            <!-- Übergibt JoinNumber und Titel korrekt an den Server -->
            <input type="hidden" asp-for="JoinNumber" />
            <input type="hidden" asp-for="Titel" />

            <!-- Quiz-Info Anzeige -->
            <div class="frage-container">
                <div class="fragebogen-feld">
                    <span class="feld-label">Join-Code:</span>
                    <span class="feld-wert">@Model.JoinNumber</span>
                </div>
                <div class="fragebogen-feld">
                    <span class="feld-label">Quiz-Titel:</span>
                    <span class="feld-wert">@Model.Titel</span>
                </div>
            </div>

            <!-- Antwortoptionen -->
            <div class="frage-container">

                <h3>Fragestellung</h3>
                <textarea name="Fragestellung" class="frage-text" placeholder="Geben Sie hier die Frage ein" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; resize: vertical; font-family: inherit; font-size: 1rem;"></textarea>

                <h3>Antwortoptionen</h3>
                <div class="antwort-grid">
                    <div class="antwort-card bg-1">
                        <input type="checkbox" name="IstAntwort1Richtig" value="true" class="checkmark" />
                        <textarea name="Antwort1" class="antwort-text" placeholder="Antwortoption 1" rows="2" style="border: none; background: transparent; resize: none; font-family: inherit;"></textarea>
                    </div>
                    <div class="antwort-card bg-2">
                        <input type="checkbox" name="IstAntwort2Richtig" value="true" class="checkmark" />
                        <textarea name="Antwort2" class="antwort-text" placeholder="Antwortoption 2" rows="2" style="border: none; background: transparent; resize: none; font-family: inherit;"></textarea>
                    </div>
                    <div class="antwort-card bg-3">
                        <input type="checkbox" name="IstAntwort3Richtig" value="true" class="checkmark" />
                        <textarea name="Antwort3" class="antwort-text" placeholder="Antwortoption 3" rows="2" style="border: none; background: transparent; resize: none; font-family: inherit;"></textarea>
                    </div>
                    <div class="antwort-card bg-4">
                        <input type="checkbox" name="IstAntwort4Richtig" value="true" class="checkmark" />
                        <textarea name="Antwort4" class="antwort-text" placeholder="Antwortoption 4" rows="2" style="border: none; background: transparent; resize: none; font-family: inherit;"></textarea>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(Model.FragenError))
            {
                <div class="frage-container" style="background-color: #f8d7da; border-left-color: #dc3545;">
                    <p style="color: #721c24; margin: 0; font-weight: 500;">@Model.FragenError</p>
                </div>
            }
        </div>

        <!-- Button Row -->
        <div class="button-row">
            <button type="submit" class="knopf haupt">Add speichern</button>
            <button type="button" onclick="closeQuizPopup()" class="knopf">Abbrechen</button>
        </div>
    </form>
</div>





<!-- Script für das öffnen des Popup -->
<script>
    function openQuizPopup(skipValidation = false) {
        const titleField = document.getElementById("quizTitle");
        const title = titleField ? titleField.value : "";

        if (!skipValidation && title.trim() === "") {
            alert("Bitte geben Sie einen Quiz-Titel ein.");
            return;
        }

        document.getElementById("quizPopup").style.display = "flex";
        document.body.style.overflow = "hidden";
    }

    function closeQuizPopup() {
        document.getElementById("quizPopup").style.display = "none";
        document.body.style.overflow = "";
=======
        container.appendChild(neu);
        frageIndex++;
    }

    function removeFrage(btn) {

        const fragen = document.querySelectorAll(".quiz-frage");

        if (fragen.length <= 1) {
            alert("Mindestens eine Frage nötig");
            return;
        }

        btn.closest(".quiz-frage").remove();
        reindex();
    }

    function reindex() {

        const fragen = document.querySelectorAll(".quiz-frage");

        fragen.forEach((f, index) => {

            f.setAttribute("data-index", index);

            const frage = f.querySelector('textarea[name*="Fragestellung"]');
            frage.name = `fb.Fragen[${index}].Fragestellung`;

            for (let i = 1; i <= 4; i++) {

                const text = f.querySelector(`textarea[name*="Antwort${i}"]`);
                text.name = `fb.Fragen[${index}].Antwort${i}`;

                const check = f.querySelector(`input[name*="IstAntwort${i}Richtig"]`);
                check.name = `fb.Fragen[${index}].IstAntwort${i}Richtig`;
                check.value = "true";
            }
        });

        frageIndex = fragen.length;
>>>>>>> Stashed changes
    }

</script>

@if (ViewData["ShowPopup"] != null && (bool)ViewData["ShowPopup"])
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            openQuizPopup(true);
        });
    </script>
}





