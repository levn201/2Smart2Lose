@page
@model Smart2Lose.Pages.Admin.FrageboegenErstellenModel

<link rel="stylesheet" href="~/css/Admin/FrageboegenErstellen.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Admin/GrundDashboard.css" asp-append-version="true" />


<!-- Header -->
<header class="header">
    <div class="logo">@Model.pn.Name</div>
    <nav class="nav-links">
        <a href="/Admin/Dashboard">Dashboard</a>

        @if (User.IsInRole("Admin"))
        {
            <a href="/Admin/ManageUser">User</a>
        }
        @if (User.IsInRole("Admin") || User.IsInRole("User") || User.IsInRole("ReadOnly"))
        {
            <a href="/Admin/Frageboegen" class="active">Frageb√∂gen</a>
        }
        @if (User.IsInRole("Admin") || User.IsInRole("User"))
        {
            <a href="/Admin/FrageboegenErstellen">Neue anlegen</a>
        }

        <a href="/Index">Quit</a>
    </nav>
</header>




<div class="main-content">

    <h2>Neues Quiz</h2>

    <form method="post" asp-page-handler="Speichern" id="fragenForm">

        <!-- META -->
        <div class="quiz-meta">

            <div class="filter-item">
                <label>Kategorie</label>
                <select name="fb.Kategorie">
                    <option value="Unternehmen">Unternehmen</option>
                    <option value="Sicherheit">Sicherheit</option>
                    <option value="Technik">Technik</option>
                    <option value="Skills">Skills</option>
                </select>
            </div>

            <div class="filter-item">
                <label>Titel</label>
                <input type="text"
                       name="fb.Titel"
                       value="@Model.fb.Titel"
                       placeholder="Quiz-Titel eingeben" />
            </div>

            <!-- Join-Code Badge: CSS erwartet .fragebogen-feld -->
            <div class="fragebogen-feld">
                <span class="feld-label">Join-Code:</span>
                <span class="feld-wert">@Model.fb.JoinId</span>
            </div>

            <!-- Muss beim Post wieder mit -->
            <input type="hidden" name="fb.JoinId" value="@Model.fb.JoinId" />

        </div>


        <!-- FRAGEN -->
        <div id="fragenContainer">

            <div class="quiz-frage">

                <h3>Frage 1</h3>

                <label>Fragestellung</label>
                <textarea class="frage-text"
                          name="fb.Fragen[0].Fragestellung"
                          placeholder="Frage eingeben..."></textarea>

                <h3>Antwortoptionen</h3>

                <div class="antwort-grid">
                    @for (int i = 1; i <= 4; i++)
                    {
                        <div class="antwort-option">

                            <textarea name="fb.Fragen[0].Antwort@(i)"
                                      placeholder="Antwort @i"></textarea>

                            <label>
                                <input type="checkbox"
                                       name="fb.Fragen[0].IstAntwort@(i)Richtig"
                                       value="true" />
                                Richtig
                            </label>

                            <!-- Wichtig: hidden NACH Checkbox, sonst wird bool immer false -->
                            <input type="hidden"
                                   name="fb.Fragen[0].IstAntwort@(i)Richtig"
                                   value="false" />

                        </div>
                    }
                </div>

            </div>

        </div>


        @if (!string.IsNullOrEmpty(Model.FragenError))
        {
            <div class="quiz-frage error-box">
                ‚ö†Ô∏è @Model.FragenError
            </div>
        }


        <div class="button-row">

            <button type="button" class="knopf" onclick="addFrage()">
                + Frage hinzuf√ºgen
            </button>

            <button type="submit" class="knopf">
                üíæ Speichern
            </button>

        </div>

    </form>

</div>


<script>
    let frageIndex = 1;

    function addFrage() {
        const container = document.getElementById("fragenContainer");
        const last = container.querySelector(".quiz-frage:last-child");
        const neu = last.cloneNode(true);

        // √úberschrift aktualisieren (nimmt das erste h3 im Block)
        neu.querySelector("h3").textContent = `Frage ${frageIndex + 1}`;

        // Fragestellung
        const frage = neu.querySelector('textarea[name*="Fragestellung"]');
        frage.name = `fb.Fragen[${frageIndex}].Fragestellung`;
        frage.value = "";

        // Antworten + bools
        for (let i = 1; i <= 4; i++) {
            const ta = neu.querySelector(`textarea[name*="Antwort${i}"]`);
            ta.name = `fb.Fragen[${frageIndex}].Antwort${i}`;
            ta.value = "";

            // Beide Inputs (checkbox + hidden) umbenennen
            const inputs = neu.querySelectorAll(`input[name*="IstAntwort${i}Richtig"]`);
            inputs.forEach(x => {
                x.name = `fb.Fragen[${frageIndex}].IstAntwort${i}Richtig`;
                if (x.type === "checkbox") x.checked = false;
                if (x.type === "hidden") x.value = "false";
            });
        }

        container.appendChild(neu);
        frageIndex++;
    }

    // Nur eine Checkbox pro Frage ausw√§hlbar (Radio-Verhalten)
    document.addEventListener("change", function (e) {
        if (e.target.type === "checkbox" && e.target.name.includes("IstAntwort")) {
            const container = e.target.closest(".quiz-frage");
            const boxes = container.querySelectorAll('input[type="checkbox"][name*="IstAntwort"]');
            boxes.forEach(b => { if (b !== e.target) b.checked = false; });
        }
    });

    // Client-seitige Validierung vor Submit
    document.getElementById("fragenForm").addEventListener("submit", function (e) {
        const fragen = document.querySelectorAll(".quiz-frage");

        for (let i = 0; i < fragen.length; i++) {
            const boxes = fragen[i].querySelectorAll('input[type="checkbox"][name*="IstAntwort"]');
            let checked = false;
            boxes.forEach(b => { if (b.checked) checked = true; });

            if (!checked) {
                alert(`Frage ${i + 1}: Bitte eine richtige Antwort w√§hlen.`);
                e.preventDefault();
                return;
            }
        }
    });
</script>