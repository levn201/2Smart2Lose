@page
@model Smart2Lose.Pages.Admin.FrageboegenErstellenModel
@{
    ViewData["Title"] = "Kahoot | Fragebögen Erstellen";
}

<link rel="stylesheet" href="~/css/Admin/GrundDashboard.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/Admin/FrageboegenErstellen.css" asp-append-version="true" />

<header class="header">
    <div class="logo">@Model.pn.Name</div>
    <nav class="nav-links">
        <a href="/Admin/Dashboard">Dashboard</a>
        <a href="/Admin/Frageboegen" class="active">Fragebögen</a>
        <a href="/Admin/FrageboegenErstellen">Neue anlegen</a>
        <a href="/Index">Quit</a>
    </nav>
</header>

<div class="main-content">

    <h2>Neues Quiz erstellen</h2>

    <!-- Quiz Meta -->
    <div class="quiz-meta">

        <form method="post" asp-page-handler="Kategorie">
            <div class="filter-item">
                <label asp-for="Kategorie">Kategorie</label>
                <select asp-for="Kategorie" class="form-select" onchange="this.form.submit()">
                    <option value="Unternehmen">Unternehmenswissen</option>
                    <option value="Sicherheit">Gesundheit & Sicherheit</option>
                    <option value="Technik">Technik & Tools</option>
                    <option value="Skills">Soft Skills</option>
                </select>
            </div>
        </form>

        <div class="titel-box">
            <label for="quizTitle">Quiz-Titel</label>
            <input type="text"
                   id="quizTitle"
                   name="Titel"
                   placeholder="Titel des Quizzes eingeben"
                   value="@Model.Titel" />
            @if (!string.IsNullOrEmpty(Model.TitelError))
            {
                <p class="message">@Model.TitelError</p>
            }

            <div class="joincode-box">
                <span>Join-Code</span>
                <strong>@Model.JoinNumber</strong>
            </div>
        </div>


    </div>

    <!-- Hauptformular -->
    <form method="post" asp-page-handler="AddFrage" id="fragenForm">

        <input type="hidden" name="Titel" id="hiddenTitel" value="@Model.Titel" />
        <input type="hidden" name="JoinNumber" value="@Model.JoinNumber" />
        <div id="fragenContainer">

            <div class="frage-container quiz-frage" data-index="0">

                <button type="button"
                        class="frage-loeschen"
                        onclick="removeFrage(this)">
                    ✖
                </button>

                <h3>Fragestellung</h3>
                <textarea class="frage-text"
                          name="Fragen[0].Fragestellung"
                          placeholder="Geben Sie hier die Frage ein"
                          rows="3"></textarea>

                <h3>Antwortoptionen</h3>

                <div class="antwort-grid">

                    <div class="antwort-option">
                        <textarea name="Fragen[0].Antwort1" placeholder="Antwort 1"></textarea>
                        <label>
                            <input type="checkbox" name="Fragen[0].IstAntwort1Richtig" />
                            Richtig
                        </label>
                    </div>

                    <div class="antwort-option">
                        <textarea name="Fragen[0].Antwort2" placeholder="Antwort 2"></textarea>
                        <label>
                            <input type="checkbox" name="Fragen[0].IstAntwort2Richtig" />
                            Richtig
                        </label>
                    </div>

                    <div class="antwort-option">
                        <textarea name="Fragen[0].Antwort3" placeholder="Antwort 3"></textarea>
                        <label>
                            <input type="checkbox" name="Fragen[0].IstAntwort3Richtig" />
                            Richtig
                        </label>
                    </div>

                    <div class="antwort-option">
                        <textarea name="Fragen[0].Antwort4" placeholder="Antwort 4"></textarea>
                        <label>
                            <input type="checkbox" name="Fragen[0].IstAntwort4Richtig" />
                            Richtig
                        </label>
                    </div>

                </div>

            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.FragenError))
        {
            <div class="frage-container error">
                @Model.FragenError
            </div>
        }

        <div class="button-row">
            <button type="button" class="knopf" onclick="addFrage()">
                Frage hinzufügen
            </button>
            <button type="button" class="knopf" onclick="speichernMitTitel()">
                Fragebogen speichern
            </button>
        </div>

    </form>

</div>

<!-- Scripts -->
<script>
    let frageIndex = 1;

    // Funktion zum Hinzufügen einer neuen Frage
    function addFrage() {
        const fragenContainer = document.getElementById('fragenContainer');
        const letzteFrage = fragenContainer.querySelector('.quiz-frage:last-child');

        const neueFrage = letzteFrage.cloneNode(true);
        neueFrage.setAttribute('data-index', frageIndex);

        // Alle Textareas und Inputs aktualisieren
        neueFrage.querySelector('textarea[name*="Fragestellung"]').name = `Fragen[${frageIndex}].Fragestellung`;
        neueFrage.querySelector('textarea[name*="Fragestellung"]').value = '';

        // Antworten aktualisieren
        for (let i = 1; i <= 4; i++) {
            const textarea = neueFrage.querySelector(`textarea[name*="Antwort${i}"]`);
            const checkbox = neueFrage.querySelector(`input[name*="IstAntwort${i}Richtig"]`);

            textarea.name = `Fragen[${frageIndex}].Antwort${i}`;
            textarea.value = '';

            checkbox.name = `Fragen[${frageIndex}].IstAntwort${i}Richtig`;
            checkbox.checked = false;
        }

        fragenContainer.appendChild(neueFrage);
        frageIndex++;
    }

    // Funktion zum Entfernen einer Frage
    function removeFrage(button) {
        const fragen = document.querySelectorAll('.quiz-frage');

        if (fragen.length <= 1) {
            alert('Mindestens eine Frage muss vorhanden sein.');
            return;
        }

        button.closest('.quiz-frage').remove();
        reindexFragen();
    }

    // Fragen neu nummerieren nach dem Löschen
    function reindexFragen() {
        const fragen = document.querySelectorAll('.quiz-frage');
        fragen.forEach((frage, index) => {
            frage.setAttribute('data-index', index);

            frage.querySelector('textarea[name*="Fragestellung"]').name = `Fragen[${index}].Fragestellung`;

            for (let i = 1; i <= 4; i++) {
                frage.querySelector(`textarea[name*="Antwort${i}"]`).name = `Fragen[${index}].Antwort${i}`;
                frage.querySelector(`input[name*="IstAntwort${i}Richtig"]`).name = `Fragen[${index}].IstAntwort${i}Richtig`;
            }
        });
        frageIndex = fragen.length;
    }

    // Titel übertragen und Formular absenden
    function speichernMitTitel() {
        const titel = document.getElementById('quizTitle').value;

        if (!titel || titel.trim() === '') {
            alert('Bitte geben Sie einen Quiz-Titel ein.');
            return;
        }

        // Titel in Hidden Field übertragen
        document.getElementById('hiddenTitel').value = titel;

        // Formular absenden
        document.getElementById('fragenForm').submit();
    }
</script>



